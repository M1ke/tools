<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convert SQL CLI to CSV</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 28px;
      }

      h2 {
        color: #444;
        margin-top: 25px;
        margin-bottom: 10px;
        font-size: 18px;
        font-weight: 600;
      }

      h3 {
        color: #555;
        margin-top: 30px;
        margin-bottom: 15px;
        font-size: 16px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 20px;
        font-size: 14px;
      }

      .subtitle a {
        color: #667eea;
        text-decoration: none;
      }

      .subtitle a:hover {
        text-decoration: underline;
      }

      p {
        color: #555;
        margin-bottom: 15px;
        line-height: 1.6;
      }

      label {
        display: block;
        font-weight: 600;
        color: #444;
        margin-bottom: 8px;
        font-size: 14px;
      }

      textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        resize: vertical;
        transition: border-color 0.3s;
        margin-bottom: 15px;
        min-height: 150px;
      }

      textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      textarea[readonly] {
        background: #f8f9fa;
      }

      input[type="text"] {
        padding: 10px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        font-size: 14px;
        transition: border-color 0.3s;
        margin-bottom: 15px;
      }

      input[type="text"]:focus {
        outline: none;
        border-color: #667eea;
      }

      .field-group {
        margin-bottom: 20px;
      }

      pre {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        overflow-x: auto;
        font-size: 13px;
        line-height: 1.4;
      }

      em {
        color: #666;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Convert SQL CLI to CSV</h1>
      <p class="subtitle">Made by M1ke - <a href="https://github.com/M1ke/tools" target="_blank" title="This opens in a new tab">Find this on GitHub</a></p>
    <h2><label for="input">Input</label></h2>
    <textarea name="input" id="input"></textarea>
    <h2><label for="output">Output</label></h2>
    <textarea name="output" id="output"></textarea>
    <p>Enter the name of a column, e.g "email" and if your CSV contains that column, the below textarea will include all values comma-separated. </p>
    <p><label for="field">Column name</label> <input type="text" name="field" id="field"/></p>
    <textarea readonly id="field-out" placeholder="Waiting for value column name"></textarea>
    <p>Wrapping lets you replace a value in a string with the value of the named column above, using the placeholder %% (two percent signs). To see how this works try out "Hello %% world %%"</p>
    <p><label for="wrap">Wrap</label> <input type="text" name="wrap" id="wrap"/></p>
    <textarea readonly id="wrap-out" placeholder="Waiting for valid column name and input to wrap (input must contain %% at least once)"></textarea>
    <p><em>All processing for this is done in your browser; no data is sent to any remote server</em></p>
    <h3>Example</h3>
    <p>If you're unsure what input this is expecting, try pasting in the following:</p>
    <pre>
+---------+--------------+
| user_id | name         |
+---------+--------------+
|       1 | Tim Fish     |
|       9 | Steve Mullet |
|      23 | Ken Salmon   |
+---------+--------------+
    </pre>
    <script type="text/javascript">
      function csvFromTable(table){
        return table.trim().split('\n').filter((line) => line[0]!=='+').map((line) => {
          line = line.substr(1, line.length-2)
          const fields = line.split(' | ')
          console.log(fields.length)
          return fields.map((field) => field.trim()).map((field) => field.replace('"', '""'))
            .map((field) => '"'+field+'"').join(',')
        }).join('\n')
      }

      function column(csvString, columnName) {
         const lines = csvString.split('\n');
         const headers = lines[0].split(',').map(h => h.replace(/"/g, ''));
         const columnIndex = headers.indexOf(columnName);
         return lines.slice(1).map(line => line.split(',')[columnIndex]).filter(val => val);
      }

      function fieldReset(){
         const fieldOutEl = document.getElementById('field-out')
        fieldOutEl.value=''
        fieldOutEl.rows=1
      }

      function wrapReset(){
        fieldReset()
         const wrapOutEl = document.getElementById('wrap-out')
        wrapOutEl.value = ''
        wrapOutEl.rows = 1
      }

      function field(csv){
        const field = document.getElementById('field').value
        if (!field){
          fieldReset()
          return;
        }
        
        console.log('finding field', { field })
        
        if (!csv){
          const input = document.getElementById('input').value
          csv = csvFromTable(input)
        }

        fieldOut(csv, field)
      }

      function fieldOut(csv, field){
        const list = column(csv, field)

        const fieldOutEl = document.getElementById('field-out')
      
        fieldOutEl.value = list.join(',')
        fieldOutEl.rows = 3
      }

      function wrap(csv){
        const field = document.getElementById('field').value
        const wrap = document.getElementById('wrap').value
        if (!field || !wrap || wrap.indexOf('%%')<0){
          wrapReset()
          return;
        }
        
        console.log('wrapping field', { field, wrap })
        
        if (!csv){
          const input = document.getElementById('input').value
          csv = csvFromTable(input)
        }

        wrapOut(csv, field, wrap)
      }

      function wrapOut(csv, field, wrap){
        // Slice(1, -1) here assumes string is always wrapped in comma, simpler than replacing them
        const list = column(csv, field).map((val) => wrap.replace(/\%\%/g, val.slice(1, -1)))

        const wrapOutEl = document.getElementById('wrap-out')
        wrapOutEl.value = list.join("\n")
        wrapOutEl.rows = list.length
      }

      document.getElementById('input').addEventListener('input', (event) => {
        console.log('Input', {event})
        const csv = csvFromTable(event.target.value)
        document.getElementById('output').value = csv

        field(csv)
        wrap(csv)
      })
      document.getElementById('field').addEventListener('input', () => field())
      document.getElementById('wrap').addEventListener('input', () => wrap())
    </script>
    </div>
  </body>
</html>
